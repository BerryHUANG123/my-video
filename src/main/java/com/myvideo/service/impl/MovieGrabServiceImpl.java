package com.myvideo.service.impl;

import com.google.common.collect.Lists;
import com.myvideo.dao.ILolDyTtGrabDao;
import com.myvideo.dao.ILolDyTtGrabErrorDao;
import com.myvideo.dao.ILolDyTtMovieDao;
import com.myvideo.grab.movie.pipeline.LolDyTtMoviePipeline;
import com.myvideo.grab.movie.processor.LolDyTtMovieProcessor;
import com.myvideo.model.persistant.*;
import com.myvideo.model.view.Result;
import com.myvideo.service.BaseService;
import com.myvideo.service.IMovieGrabService;
import com.myvideo.utils.ResultUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import us.codecraft.webmagic.Spider;

import java.util.Date;
import java.util.List;

@Service
public class MovieGrabServiceImpl extends BaseService implements IMovieGrabService {

    @Autowired
    private ILolDyTtGrabDao lolDyTtGrabDao;
    @Autowired
    private LolDyTtMovieProcessor lolDyTtMovieProcessor;
    @Autowired
    private LolDyTtMoviePipeline lolDyTtMoviePipeline;
    @Autowired
    private ILolDyTtGrabErrorDao lolDyTtGrabErrorDao;
    @Autowired
    private ILolDyTtMovieDao lolDyTtMovieDao;

    @Override
    public Result grabForAll() {
        //type
        //动作电影 Dongzuodianying
        //科幻电影 Kehuandianying
        //恐怖电影 Kongbudianying
        //喜剧电影 Xijudianying
        //爱情电影 Aiqingdianying
        //剧情电影 Juqingdianying
        //战争电影 Zhanzhengdianying
        //动漫 Anime

        //公共
        //https://www.loldytt.com/[type]/chart/1.html
        //TODO:从数据库中读取上次抓取的情况
        try {
            LolDyTtGrabPoExample grabPoExample = new LolDyTtGrabPoExample();
            LolDyTtGrabPoExample.Criteria criteria = grabPoExample.createCriteria();
            criteria.andIdNotEqualTo(0);
            List<LolDyTtGrabPo> lolDyTtGrabPoList = lolDyTtGrabDao.selectByExample(grabPoExample);
            for (LolDyTtGrabPo grabPo : lolDyTtGrabPoList) {
                String type = grabPo.getType();
                Date lastGrabEndTime = grabPo.getLastGrabEndTime();
                Date lastGrabStartTime = grabPo.getLastGrabStartTime();
                Integer lastGrabPageNum = grabPo.getLastGrabPageNum();
                Integer lastTotalPageNum = grabPo.getLastTotalPageNum();

                if (lastGrabPageNum == null || lastGrabPageNum.equals(0)) lastGrabPageNum = 1;

                //更新开始抓取时间
                grabPo.setLastGrabStartTime(new Date());
                lolDyTtGrabDao.updateByPrimaryKeySelective(grabPo);

                Spider.create(lolDyTtMovieProcessor)
                        .addUrl("https://www.loldytt.com/" + type + "/chart/" + lastGrabPageNum + ".html")
                        //.addUrl("https://www.loldytt.com/Dongzuodianying/WJWZZZ/")
                        //.addUrl("https://www.loldytt.com/Juqingdianying/15D17FQCBL/")
                        //开启5个线程抓取
                        .thread(40)
                        .addPipeline(lolDyTtMoviePipeline)
                        //启动爬虫
                        .run();

                //更新结束抓取时间
                grabPo.setLastGrabEndTime(new Date());
                lolDyTtGrabDao.updateByPrimaryKeySelective(grabPo);
            }
        } catch (Exception e) {
            logger.error("MovieGrabServiceImpl->grabForAll:", e);
            return ResultUtil.returnError(e.getMessage());
        }
        return ResultUtil.returnSuccess();
    }

    @Override
    public Result grabForError() {
        //从数据库中读取所有错误记录
        LolDyTtGrabErrorPoExample grabErrorPoExample = new LolDyTtGrabErrorPoExample();
        LolDyTtGrabErrorPoExample.Criteria criteria = grabErrorPoExample.createCriteria();
        criteria.andIdGreaterThan(0L);
        List<LolDyTtGrabErrorPo> grabErrorPoList = lolDyTtGrabErrorDao.selectByExample(grabErrorPoExample);
        for (LolDyTtGrabErrorPo lolDyTtGrabErrorPo : grabErrorPoList) {
            //先删除掉错误行,再抓取
            lolDyTtGrabErrorDao.deleteByPrimaryKey(lolDyTtGrabErrorPo.getId());
            Spider.create(lolDyTtMovieProcessor)
                    .addUrl(lolDyTtGrabErrorPo.getPageUrl())
                    //开启5个线程抓取
                    .thread(1)
                    .addPipeline(lolDyTtMoviePipeline)
                    //启动爬虫
                    .run();
        }
        return ResultUtil.returnSuccess();
    }

    /**
     * 临时修复数据缺失的方法
     *
     * @return result
     */
    @Override
    public Result grabForNoDownloadList() {
        //找出所有没有下载地址的行
        LolDyTtMoviePoExample lolDyTtMoviePoExample = new LolDyTtMoviePoExample();
        LolDyTtMoviePoExample.Criteria criteria = lolDyTtMoviePoExample.createCriteria();
        List<Long> idList = Lists.newArrayList(101L,105L,110L,120L,126L,129L,131L,132L,137L,138L,139L,145L,146L,147L,149L,152L,153L,154L,155L,156L,158L,162L,163L,168L,170L,172L,176L,184L,187L,189L,192L,201L,202L,205L,210L,211L,214L,215L,217L,218L,220L,221L,223L,225L,227L,228L,231L,235L,237L,239L,241L,242L,243L,247L,256L,257L,260L,266L,267L,271L,276L,281L,283L,284L,285L,294L,303L,308L,313L,318L,321L,322L,329L,332L,333L,341L,356L,358L,371L,386L,399L,410L,477L,479L,547L,564L,579L,642L,649L,665L,689L,701L,718L,720L,723L,729L,734L,757L,760L,772L,793L,807L,823L,830L,861L,865L,941L,2129L,2131L,2134L,2141L,2170L,2178L,2193L,2198L,2201L,2202L,2211L,2212L,2249L,2353L,2399L,2417L,2429L,2432L,2433L,2437L,2438L,2439L,2440L,2445L,2453L,2455L,2458L,2460L,2461L,2462L,2467L,2470L,2472L,2474L,2476L,2483L,2485L,2491L,2496L,2501L,2504L,2506L,2516L,2518L,2520L,2522L,2523L,2525L,2527L,2532L,2554L,2565L,2593L,2612L,2614L,2617L,2618L,2621L,2623L,2624L,2625L,2626L,2628L,2629L,2631L,2633L,2635L,2641L,2649L,2663L,2665L,2668L,2670L,2671L,2672L,2675L,2679L,2680L,2684L,2687L,2689L,2693L,2705L,2715L,2722L,2726L,2727L,2728L,2735L,2736L,2738L,2740L,2743L,2750L,2761L,2788L,2789L,2806L,2820L,2825L,2834L,2837L,2842L,2846L,2854L,2874L,2903L,2907L,2921L,3040L,3056L,3079L,3170L,3208L,3209L,3216L,3244L,3249L,3254L,3259L,3266L,3273L,3277L,3317L,3323L,3328L,3330L,3332L,3337L,3338L,3341L,3343L,3344L,3346L,3348L,3362L,3369L,3371L,3373L,3397L,3407L,3431L,3442L,3448L,3457L,3458L,3460L,3472L,3587L,5331L,5337L,5356L,5360L,5368L,5370L,5371L,5375L,5385L,5393L,5394L,5400L,5402L,5406L,5414L,5418L,5424L,5425L,5427L,5440L,5445L,5449L,5452L,5456L,5458L,5472L,5476L,5486L,5496L,5500L,5501L,5503L,5507L,5510L,5511L,5512L,5514L,5517L,5518L,5519L,5528L,5533L,5534L,5538L,5539L,5548L,5558L,5561L,5588L,5616L,5627L,5643L,5646L,5648L,5652L,5653L,5654L,5655L,5661L,5667L,5668L,5669L,5680L,5688L,5690L,5705L,5711L,5721L,5725L,5727L,5728L,5729L,5736L,5742L,5750L,5751L,5754L,5756L,5757L,5763L,5764L,5767L,5768L,5769L,5771L,5776L,5777L,5780L,5794L,5795L,5806L,5820L,5848L,5854L,5867L,5878L,5883L,5938L,5952L,5966L,5970L,5992L,5996L,6019L,6022L,6041L,6113L,6115L,6180L,6217L,6228L,6232L,6236L,6244L,6262L,6297L,6302L,6366L,6398L,6401L,6421L,6442L,6478L,6483L,6491L,6586L,6598L,6606L,6651L,6691L,6703L,6705L,6747L,6777L,6942L,6979L,7044L,8145L,8332L,8360L,8366L,8393L,8489L,8586L,8687L,8719L,8795L,8924L,8927L,8940L,8942L,8945L,8948L,8953L,8962L,8965L,8969L,8971L,8974L,8975L,8976L,8979L,8988L,8994L,8996L,9010L,9015L,9017L,9024L,9025L,9028L,9033L,9039L,9040L,9041L,9047L,9051L,9052L,9072L,9083L,9087L,9095L,9099L,9101L,9115L,9118L,9136L,9139L,9141L,9142L,9145L,9147L,9150L,9151L,9155L,9157L,9160L,9165L,9167L,9168L,9170L,9175L,9179L,9180L,9181L,9187L,9192L,9207L,9211L,9216L,9218L,9223L,9226L,9227L,9232L,9233L,9239L,9240L,9245L,9246L,9247L,9248L,9251L,9255L,9258L,9260L,9261L,9263L,9266L,9268L,9270L,9276L,9279L,9280L,9281L,9285L,9287L,9288L,9290L,9299L,9300L,9301L,9302L,9303L,9304L,9305L,9313L,9316L,9317L,9318L,9319L,9320L,9321L,9323L,9325L,9326L,9327L,9328L,9330L,9333L,9335L,9336L,9345L,9348L,9350L,9354L,9357L,9358L,9367L,9368L,9371L,9373L,9374L,9375L,9380L,9381L,9383L,9384L,9385L,9386L,9387L,9391L,9393L,9399L,9401L,9403L,9404L,9405L,9407L,9408L,9410L,9413L,9415L,9418L,9420L,9421L,9425L,9427L,9428L,9429L,9433L,9434L,9438L,9439L,9440L,9442L,9443L,9444L,9446L,9447L,9449L,9454L,9456L,9457L,9459L,9463L,9465L,9466L,9467L,9468L,9472L,9478L,9479L,9480L,9492L,9504L,9505L,9506L,9508L,9516L,9520L,9524L,9535L,9538L,9541L,9543L,9545L,9547L,9554L,9563L,9564L,9569L,9572L,9576L,9577L,9581L,9582L,9587L,9589L,9595L,9597L,9598L,9599L,9603L,9604L,9605L,9606L,9608L,9611L,9626L,9628L,9632L,9633L,9637L,9639L,9640L,9642L,9643L,9644L,9648L,9649L,9650L,9651L,9654L,9655L,9656L,9661L,9668L,9669L,9672L,9676L,9677L,9678L,9681L,9682L,9687L,9688L,9690L,9691L,9693L,9695L,9699L,9703L,9704L,9705L,9710L,9713L,9716L,9717L,9718L,9720L,9722L,9724L,9725L,9730L,9733L,9734L,9737L,9738L,9739L,9740L,9747L,9751L,9752L,9754L,9755L,9756L,9757L,9758L,9761L,9767L,9768L,9773L,9774L,9777L,9778L,9779L,9780L,9783L,9794L,9795L,9796L,9803L,9806L,9816L,9817L,9821L,9823L,9824L,9827L,9834L,9836L,9843L,9848L,9850L,9853L,9854L,9856L,9860L,9862L,9864L,9865L,9866L,9868L,9869L,9870L,9873L,9880L,9881L,9882L,9883L,9886L,9887L,9888L,9889L,9890L,9893L,9895L,9896L,9900L,9902L,9903L,9904L,9905L,9906L,9911L,9913L,9917L,9921L,9922L,9923L,9925L,9926L,9930L,9933L,9939L,9940L,9941L,9942L,9943L,9944L,9947L,9948L,9949L,9951L,9952L,9958L,9959L,9961L,9962L,9963L,9967L,9981L,9985L,9987L,9990L,9992L,9998L,10000L,10002L,10003L,10004L,10005L,10009L,10010L,10012L,10013L,10014L,10015L,10017L,10018L,10019L,10020L,10021L,10022L,10023L,10024L,10025L,10027L,10028L,10029L,10031L,10032L,10037L,10038L,10040L,10042L,10044L,10045L,10046L,10047L,10048L,10049L,10050L,10052L,10057L,10058L,10063L,10074L,10075L,10080L,10095L,10098L,10099L,10101L,10105L,10106L,10107L,10110L,10111L,10113L,10118L,10120L,10123L,10125L,10127L,10128L,10129L,10130L,10131L,10134L,10135L,10137L,10139L,10141L,10143L,10144L,10145L,10147L,10152L,10154L,10159L,10161L,10162L,10163L,10165L,10166L,10168L,10171L,10172L,10174L,10177L,10178L,10179L,10183L,10186L,10190L,10191L,10192L,10194L,10198L,10201L,10202L,10204L,10211L,10212L,10214L,10217L,10218L,10222L,10223L,10224L,10225L,10226L,10228L,10230L,10232L,10233L,10235L,10238L,10240L,10241L,10242L,10245L,10246L,10249L,10255L,10257L,10263L,10264L,10265L,10267L,10269L,10272L,10273L,10275L,10276L,10278L,10279L,10280L,10281L,10283L,10284L,10287L,10289L,10291L,10292L,10293L,10294L,10295L,10300L,10301L,10302L,10303L,10305L,10310L,10312L,10315L,10316L,10317L,10318L,10319L,10320L,10323L,10325L,10326L,10330L,10331L,10332L,10334L,10336L,10340L,10346L,10361L,10364L,10370L,10371L,10372L,10378L,10379L,10381L,10385L,10386L,10393L,10397L,10404L,10409L,10410L,10411L,10413L,10414L,10415L,10420L,10423L,10428L,10432L,10437L,10438L,10440L,10442L,10443L,10444L,10449L,10450L,10453L,10455L,10459L,10460L,10464L,10466L,10471L,10473L,10474L,10475L,10485L,10487L,10494L,10495L,10496L,10499L,10500L,10503L,10504L,10506L,10508L,10510L,10511L,10520L,10527L,10534L,10550L,10553L,10559L,10564L,10566L,10570L,10571L,10637L,10638L,10648L,10668L,10676L,10677L,10678L,10713L,10741L,10749L,10750L,10751L,10759L,10763L,10764L,10778L,10784L,10792L,10800L,10802L,10809L,10829L,10830L,10836L,10839L,10853L,10871L,10902L,10951L,10971L,10986L,11024L,11044L,11084L,11094L,11117L,11120L,11159L,11183L,11185L,11189L,11227L,11271L,11293L,11305L,11345L,11378L,11512L,11521L,11524L,11536L,11547L,11560L,11596L,11600L,11651L,11684L,11690L,11694L,11736L,11786L,11793L,11814L,11896L,11905L,11991L,12025L,12049L,12055L,12143L,12163L,12204L,12275L,12276L,12295L,12305L,12306L,12353L,12405L,12456L,12558L,12621L,12627L,12632L,12643L,12662L,12664L,12670L,12680L,12724L,12731L,12780L,12835L,12860L,12874L,12923L,12925L,12929L,12936L,12943L,12946L,12952L,12985L,13021L,13040L,13044L,13050L,13074L,13086L,13102L,13112L,13122L,13143L,13162L,13168L,13189L,13235L,13236L,13248L,13274L,13275L,13290L,13296L,13310L,13345L,13348L,13358L,13363L,13374L,13400L,14241L,14308L,16336L,16345L,16348L,16349L,16350L,16352L,16354L,16359L,16370L,16371L,16403L,16410L,16411L,16420L,16421L,16428L,16431L,16458L,16460L,16461L,16462L,16465L,16469L,16480L,16487L,16490L,16493L,16497L,16529L,16575L,16631L,16638L,16649L,16671L,16675L,16719L,16742L,16751L,16755L,16793L,16826L,16833L,16841L,16862L,16876L,16886L,16889L,16911L,16917L,17229L,17243L,17383L,17386L,17394L,17398L,17399L,17401L,17414L,17415L,17432L,17434L,17440L,17442L,17444L,17445L,17447L,17448L,17450L,17452L,17454L,17455L,17456L,17461L,17463L,17464L,17467L,17472L,17479L,17480L,17481L,17486L,17492L,17494L,17505L,17506L,17509L,17510L,17516L,17519L,17524L,17525L,17527L,17528L,17529L,17541L,17543L,17546L,17547L,17554L,17555L,17557L,17559L,17561L,17564L,17566L,17570L,17571L,17572L,17573L,17575L,17580L,17584L,17589L,17590L,17591L,17593L,17598L,17600L,17605L,17614L,17617L,17619L,17620L,17631L,17634L,17646L,17647L,17653L,17655L,17656L,17665L,17668L,17671L,17672L,17675L,17677L,17679L,17681L,17685L,17694L,17695L,17702L,17703L,17705L,17706L,17709L,17712L,17715L,17729L,17740L,17743L,17748L,17751L,17752L,17754L,17755L,17756L,17760L,17768L,17777L,17787L,17788L,17793L,17796L,17797L,17799L,17802L,17807L,17808L,17813L,17822L,17824L,17833L,17845L,17855L,17862L,17919L,17921L,18001L,18011L,18016L,18039L,18042L,18061L,18075L,18080L,18116L,18142L,18175L,18182L,18192L,18244L,18283L,18309L,18312L,18324L,18333L,18352L,18380L,18397L,18405L,18416L,18418L,18419L,18422L,18430L,18440L,18441L,18468L,18503L,18526L,18542L,18553L,18571L,18575L,18620L,18641L,19926L,19938L,19941L,19947L,19969L,19972L,19973L,19976L,19979L,19980L,19981L,19982L,19985L,19993L,19997L,20004L,20006L,20008L,20012L,20022L,20024L,20027L,20028L,20029L,20031L,20032L,20039L,20042L,20048L,20050L,20052L,20053L,20054L,20055L,20057L,20059L,20060L,20065L,20066L,20068L,20072L,20073L,20075L,20078L,20079L,20080L,20082L,20083L,20084L,20085L,20087L,20089L,20091L,20093L,20096L,20097L,20098L,20101L,20108L,20115L,20120L,20123L,20126L,20135L,20146L,20147L,20148L,20152L,20157L,20159L,20161L,20162L,20164L,20167L,20171L,20175L,20176L,20178L,20180L,20181L,20182L,20183L,20184L,20185L,20188L,20189L,20190L,20192L,20194L,20201L,20203L,20209L,20210L,20211L,20213L,20214L,20216L,20219L,20222L,20224L,20229L,20232L,20234L,20236L,20237L,20238L,20239L,20241L,20242L,20246L,20248L,20249L,20250L,20254L,20265L,20271L,20272L,20288L,20289L,20294L,20297L,20303L,20306L,20307L,20312L,20313L,20315L,20318L,20323L,20325L,20327L,20331L,20332L,20336L,20338L,20341L,20346L,20350L,20353L,20354L,20355L,20357L,20359L,20360L,20362L,20364L,20365L,20367L,20371L,20373L,20375L,20376L,20377L,20380L,20381L,20382L,20383L,20384L,20386L,20389L,20393L,20394L,20398L,20399L,20404L,20405L,20408L,20410L,20422L,20426L,20428L,20430L,20435L,20437L,20441L,20443L,20445L,20446L,20447L,20449L,20450L,20451L,20452L,20454L,20455L,20456L,20457L,20462L,20465L,20469L,20470L,20472L,20473L,20477L,20481L,20482L,20483L,20489L,20492L,20494L,20495L,20499L,20500L,20501L,20503L,20504L,20507L,20509L,20510L,20513L,20514L,20515L,20517L,20521L,20522L,20525L,20526L,20529L,20530L,20533L,20536L,20537L,20538L,20540L,20542L,20543L,20544L,20546L,20550L,20553L,20557L,20562L,20568L,20572L,20575L,20584L,20587L,20589L,20592L,20593L,20597L,20598L,20600L,20601L,20621L,20630L,20652L,20657L,20665L,20727L,20728L,20732L,20753L,20771L,20789L,20828L,20834L,20865L,20896L,20897L,20901L,20937L,20957L,20978L,20994L,20997L,21046L,21050L,21061L,21069L,21086L,21089L,21106L,21109L,21141L,21145L,21157L,21162L,21182L,21219L,21241L,21242L,21263L,21284L,21285L,21337L,21341L,21375L,21404L,21415L,21421L,21493L,21515L,21535L,21554L,21568L,21580L,21602L,21614L,21626L,21661L,21668L,21680L,21685L,21706L,21718L,21724L,21735L,21738L,21739L,21754L,21760L,21762L,21767L,21777L,21784L,21791L,21824L,23247L,23257L,23259L,23269L,23270L,23272L,23279L,23280L,23289L,23292L,23293L,23300L,23306L,23308L,23309L,23324L,23329L,23338L,23340L,23348L,23359L,23434L,23438L,23459L);
        criteria.andIdIn(idList);
        List<LolDyTtMoviePo> list = lolDyTtMovieDao.selectByExampleWithBLOBs(lolDyTtMoviePoExample);
        for (LolDyTtMoviePo lolDyTtMoviePo : list) {
            Spider.create(lolDyTtMovieProcessor).addPipeline(lolDyTtMoviePipeline).thread(5).addUrl(lolDyTtMoviePo.getSourceUrl()).run();
        }
        return ResultUtil.returnSuccess();
    }

}
